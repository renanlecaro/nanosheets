export function NanoSheets(h,{data:p={},onChange:i=()=>null,cellWidth:d=200,cellHeight:g=40,style:x=({x:t,y:e,value:n,selected:o})=>({padding:"0 10px",borderBottom:"1px solid #dadada",borderRight:"1px solid #dadada",background:o?"#e2f7ff":"white",transition:"background 0.1s",color:"black",outline:"none",whiteSpace:"nowrap"}),defaultValue:b=({x:t,y:e})=>""}){Object.assign(h.style,{overflow:"auto",position:"relative",border:"1px solid #dadada"});h.setAttribute("tabindex","-1");let m,w=0;const v=t=>t.split("_").map(t=>parseInt(t));let y=false;let M="0_0";let D=null;const k=document.createElement("input");k.setAttribute("type","search");Object.assign(k.style,{zIndex:2,font:"inherit",lineHeight:g+"px",width:d+"px",height:g+"px",position:"absolute",boxSizing:"border-box",border:"2px solid #00aae1",borderRadius:"2px",transition:"left 0.2s, top 0.2s",padding:"0 8px"});h.appendChild(k);function E(){const t=h.getBoundingClientRect();m=Math.ceil(t.width/d)+1;w=Math.ceil(t.height/g)+1;const e=m*w;while(h.children.length-1<e){const n=document.createElement("div");h.appendChild(n)}while(h.children.length-1>e){h.removeChild(h.children[1])}}function c(){const[t,e]=v(M);Object.assign(k.style,{left:d*t+"px",top:g*e+"px",background:y?"white":"transparent",color:y?"black":"transparent",pointerEvents:y?"all":"none"});E();const n=Math.floor(h.scrollLeft/d);const o=Math.floor(h.scrollTop/g);const[l,i,s,r]=D||[-1,-1,-1,-1];for(let e=0;e<m;e++){for(let t=0;t<w;t++){const a=n+e;const c=o+t;const f=a+"_"+c;const u=h.children[t*m+e+1];u.style="";Object.assign(u.style,{lineHeight:g+"px",position:"absolute",boxSizing:"border-box",overflow:"hidden",left:d*a+"px",top:g*c+"px",width:d+"px",height:g+"px",...x({x:a,y:c,value:p[f]||b({x:a,y:c}),selected:R(a,l,s)&&R(c,i,r),cursor:M===f})});u.textContent=p[f]||b({x:a,y:c});u.setAttribute("cell",f)}}}const n=[];const t=new ResizeObserver(c);function e(){n.forEach(({node:t,args:e})=>t.removeEventListener(...e));t.unobserve(h);[h.children].forEach(t=>t.remove());h.style=""}function o(t,...e){t.addEventListener(...e);n.push({node:t,args:e})}t.observe(h);o(h,"scroll",c);c();function s(t){let e=false;for(const n in t){const[o,l]=v(n);if((p[n]||"")!==(t[n]||"")){if(t[n]!==b({x:o,y:l})){p[n]=t[n]}else{delete p[n]}e=true}}if(e){i(p)}}o(k,"focus",()=>{if(M&&!D){const[t,e]=v(M);D=[t,e,t,e];c()}});o(k,"blur",()=>{A();D=null;c()});function l(){if(y){s({[M]:k.value})}}o(k,"keydown",t=>{const[e,n]=v(M);const o=Object.keys(p).map(t=>v(t));const l=Math.max(...o.map(t=>t[0]),e);const i={ArrowRight:[1,0],ArrowLeft:[-1,0],ArrowDown:[0,1],ArrowUp:[0,-1],Enter:[0,1],PageDown:[0,w-1],PageUp:[0,-(w-1)],Home:[-e,0],End:[l-e,0]};const s=i[t.key];if(t.key==="Delete"||t.key==="Backspace"){O();c()}else if(s){A();const[r,a]=s;if(t.shiftKey){D[2]=Math.max(0,D[2]+r);D[3]=Math.max(0,D[3]+a);u(D[2],D[3])}else{f(Math.max(0,e+r),Math.max(0,n+a))}c()}},true);o(k,"input",t=>{if(!y&&k.value){const[e,n]=v(M);const o=k.value;r(e,n);k.value=o;c()}});function f(t,e){M=[t,e].join("_");D=[t,e,t,e];c();k.focus();u(t,e)}function u(t,e){const{width:n,height:o}=h.getBoundingClientRect();if(h.scrollLeft+n<(t+1)*d){h.scrollLeft=(t+1)*d-n}else if(t*d<h.scrollLeft){h.scrollLeft=t*d}if(h.scrollTop+o<(e+1)*g){h.scrollTop=(e+1)*g-o}else if(e*g<h.scrollTop){h.scrollTop=e*g}}function A(){if(y){l();y=false;k.value=""}}function r(t,e){const n=[t,e].join("_");if(!y||M!==n){M=n;k.value=p[n]||b({x:t,y:e});y=true}c()}let a=0;o(h,"mousedown",t=>{const e=t.target.getAttribute("cell");if(!e||t.buttons!==1)return;t.preventDefault();const[n,o]=v(e);if(Date.now()-400<a&&e===M){r(n,o)}else{A();a=Date.now();if(e!==M){f(n,o)}}c()},true);o(h,"mouseenter",t=>{if(t.buttons===1&&D){const e=t.target.getAttribute("cell");if(D&&e){const[n,o]=v(e);D[2]=n;D[3]=o;c()}}},true);o(k,"paste",t=>{if(y)return;t.preventDefault();const e=j((t.clipboardData||window.clipboardData).getData("text/plain"));const o={};const[l,i]=v(M);e.forEach((t,n)=>t.forEach((t,e)=>o[l+e+"_"+(i+n)]=t));s(o);D=[l,i,l+e[0].length-1,i+e.length-1];c()});function L(t){t.preventDefault();const[n,o,l,i]=D;const s=[];for(let e=Math.min(o,i);e<=Math.max(o,i);e++){const r=[];for(let t=Math.min(n,l);t<=Math.max(n,l);t++){r.push(p[t+"_"+e]||b({x:t,y:e}))}s.push(r)}t.clipboardData.setData("text/plain",C(s))}o(k,"copy",t=>{if(!y){L(t)}});function O(){const n={};const[o,t,l,i]=D;for(let e=Math.min(t,i);e<=Math.max(t,i);e++){for(let t=Math.min(o,l);t<=Math.max(o,l);t++){n[t+"_"+e]=""}}s(n)}o(k,"cut",t=>{if(!y){L(t);O();c()}});return{destroy:e,scrollTo:u,redraw:c,data:p};function _(t){return t.split('"').length-1}function j(t){let e,n,o,l=[],i=0,s,r,a,c;o=t.split("\n");if(o.length>1&&o[o.length-1]===""){o.pop()}for(e=0,n=o.length;e<n;e+=1){o[e]=o[e].split("\t");for(s=0,r=o[e].length;s<r;s+=1){if(!l[i]){l[i]=[]}if(a&&s===0){c=l[i].length-1;l[i][c]=l[i][c]+"\n"+o[e][0];if(a&&_(o[e][0])&1){a=false;l[i][c]=l[i][c].substring(0,l[i][c].length-1).replace(/""/g,'"')}}else{if(s===r-1&&o[e][s].indexOf('"')===0&&_(o[e][s])&1){l[i].push(o[e][s].substring(1).replace(/""/g,'"'));a=true}else{l[i].push(o[e][s].replace(/""/g,'"'));a=false}}}if(!a){i+=1}}return l}function C(t){let e,n,o,l,i="",s;for(e=0,n=t.length;e<n;e+=1){for(o=0,l=t[e].length;o<l;o+=1){if(o>0){i+="\t"}s=t[e][o];if(typeof s==="string"){if(s.indexOf("\n")>-1){i+='"'+s.replace(/"/g,'""')+'"'}else{i+=s}}else if(s===null||s===void 0){i+=""}else{i+=s}}i+="\n"}return i}function R(t,e,n){return t>=Math.min(e,n)&&t<=Math.max(e,n)}}